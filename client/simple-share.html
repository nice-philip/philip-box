<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê°„ë‹¨í•œ íŒŒì¼ ê³µìœ ê¸° - Philip Box</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f4f8;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 50px;
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
      width: 400px;
      margin-bottom: 20px;
    }
    input[type="file"] {
      margin-bottom: 20px;
      padding: 10px;
      border: 2px dashed #007bff;
      border-radius: 5px;
      width: 100%;
      background: #f8f9ff;
    }
    button {
      padding: 12px 24px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    .link {
      margin-top: 20px;
      word-break: break-all;
      font-size: 14px;
      color: #333;
      padding: 15px;
      background: #e8f4f8;
      border-radius: 5px;
      text-align: left;
    }
    .file-info {
      margin-top: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
      font-size: 14px;
    }
    .shared-files {
      margin-top: 30px;
      text-align: left;
    }
    .shared-file {
      padding: 10px;
      margin: 5px 0;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
    }
    .shared-file:hover {
      background: #f0f8ff;
    }
    .download-section {
      margin-top: 30px;
      padding: 20px;
      background: #fff3cd;
      border-radius: 5px;
      border: 1px solid #ffeaa7;
    }
  </style>
</head>
<body>

  <div class="container">
    <h2>ğŸ“ ê°„ë‹¨í•œ íŒŒì¼ ê³µìœ ê¸°</h2>
    <p>íŒŒì¼ì„ ì„ íƒí•˜ê³  ê³µìœ  ë§í¬ë¥¼ ìƒì„±í•˜ì„¸ìš”</p>
    
    <input type="file" id="fileInput" multiple />
    <div class="file-info" id="fileInfo"></div>
    
    <button onclick="generateShareLink()">ğŸ”— ê³µìœ  ë§í¬ ìƒì„±</button>
    <button onclick="clearAll()">ğŸ—‘ï¸ ëª¨ë‘ ì‚­ì œ</button>
    
    <div class="link" id="shareResult"></div>
  </div>

  <div class="container">
    <h3>ğŸ“‹ ê³µìœ ëœ íŒŒì¼ ëª©ë¡</h3>
    <div class="shared-files" id="sharedFiles"></div>
  </div>

  <div class="container download-section" id="downloadSection" style="display: none;">
    <h3>â¬‡ï¸ ë‹¤ìš´ë¡œë“œ</h3>
    <div id="downloadContent"></div>
  </div>

  <script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.onload = function() {
      loadSharedFiles();
      checkForDownload();
    };

    // íŒŒì¼ ì„ íƒ ì‹œ ì •ë³´ í‘œì‹œ
    document.getElementById('fileInput').addEventListener('change', function() {
      const files = this.files;
      const fileInfo = document.getElementById('fileInfo');
      
      if (files.length === 0) {
        fileInfo.innerHTML = '';
        return;
      }

      let info = `<strong>ì„ íƒëœ íŒŒì¼ (${files.length}ê°œ):</strong><br>`;
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const size = formatFileSize(file.size);
        info += `ğŸ“„ ${file.name} (${size})<br>`;
      }
      fileInfo.innerHTML = info;
    });

    function generateShareLink() {
      const fileInput = document.getElementById("fileInput");
      const files = fileInput.files;

      if (files.length === 0) {
        alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      // íŒŒì¼ë“¤ì„ ì €ì¥í•˜ê³  ê³µìœ  ë§í¬ ìƒì„±
      const shareId = generateId();
      const shareData = {
        id: shareId,
        files: [],
        createdAt: new Date().toISOString(),
        accessCount: 0
      };

      // íŒŒì¼ ë°ì´í„°ë¥¼ ì½ì–´ì„œ ì €ì¥
      let processedFiles = 0;
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();
        
        reader.onload = function(e) {
          shareData.files.push({
            name: file.name,
            size: file.size,
            type: file.type,
            data: e.target.result,
            lastModified: file.lastModified
          });
          
          processedFiles++;
          
          if (processedFiles === files.length) {
            // ëª¨ë“  íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ
            saveShareData(shareData);
            showShareResult(shareData);
            loadSharedFiles();
          }
        };
        
        reader.readAsDataURL(file);
      }
    }

    function saveShareData(shareData) {
      const allShares = JSON.parse(localStorage.getItem('philipbox_shares') || '{}');
      allShares[shareData.id] = shareData;
      localStorage.setItem('philipbox_shares', JSON.stringify(allShares));
    }

    function showShareResult(shareData) {
      const shareResult = document.getElementById('shareResult');
      const shareUrl = `${window.location.origin}${window.location.pathname}?share=${shareData.id}`;
      
      shareResult.innerHTML = `
        <strong>âœ… ê³µìœ  ë§í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</strong><br><br>
        <strong>ê³µìœ  ë§í¬:</strong><br>
        <a href="${shareUrl}" target="_blank" style="color: #007bff;">${shareUrl}</a><br><br>
        <button onclick="copyToClipboard('${shareUrl}')" style="background: #28a745;">ğŸ“‹ ë§í¬ ë³µì‚¬</button>
        <button onclick="window.open('${shareUrl}', '_blank')" style="background: #17a2b8;">ğŸ”— ë§í¬ ì—´ê¸°</button><br><br>
        <small>ğŸ“ íŒŒì¼ ${shareData.files.length}ê°œê°€ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤.</small>
      `;
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(function() {
        alert('ğŸ“‹ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
      }, function(err) {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        // ëŒ€ì²´ ë°©ë²•
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('ğŸ“‹ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
      });
    }

    function loadSharedFiles() {
      const allShares = JSON.parse(localStorage.getItem('philipbox_shares') || '{}');
      const sharedFilesDiv = document.getElementById('sharedFiles');
      
      const shareIds = Object.keys(allShares);
      
      if (shareIds.length === 0) {
        sharedFilesDiv.innerHTML = '<p style="text-align: center; color: #666;">ê³µìœ ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      let html = '';
      shareIds.forEach(shareId => {
        const shareData = allShares[shareId];
        const createdAt = new Date(shareData.createdAt).toLocaleString('ko-KR');
        const fileCount = shareData.files.length;
        
        html += `
          <div class="shared-file" onclick="viewSharedFile('${shareId}')">
            <strong>ğŸ“ ê³µìœ  ID: ${shareId}</strong><br>
            <small>ğŸ“… ìƒì„±ì¼: ${createdAt}</small><br>
            <small>ğŸ“„ íŒŒì¼ ìˆ˜: ${fileCount}ê°œ</small><br>
            <small>ğŸ‘€ ì ‘ê·¼ íšŸìˆ˜: ${shareData.accessCount}íšŒ</small>
            <button onclick="event.stopPropagation(); deleteShare('${shareId}')" style="background: #dc3545; font-size: 12px; padding: 5px 10px; margin-top: 5px;">ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>
        `;
      });
      
      sharedFilesDiv.innerHTML = html;
    }

    function viewSharedFile(shareId) {
      const shareUrl = `${window.location.origin}${window.location.pathname}?share=${shareId}`;
      window.open(shareUrl, '_blank');
    }

    function deleteShare(shareId) {
      if (confirm('ì´ ê³µìœ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const allShares = JSON.parse(localStorage.getItem('philipbox_shares') || '{}');
        delete allShares[shareId];
        localStorage.setItem('philipbox_shares', JSON.stringify(allShares));
        loadSharedFiles();
        alert('ğŸ—‘ï¸ ê³µìœ ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    }

    function clearAll() {
      if (confirm('ëª¨ë“  ê³µìœ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem('philipbox_shares');
        document.getElementById('shareResult').innerHTML = '';
        document.getElementById('fileInfo').innerHTML = '';
        document.getElementById('fileInput').value = '';
        loadSharedFiles();
        alert('ğŸ—‘ï¸ ëª¨ë“  ê³µìœ ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    }

    // URLì—ì„œ ê³µìœ  ID í™•ì¸í•˜ì—¬ ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ í‘œì‹œ
    function checkForDownload() {
      const urlParams = new URLSearchParams(window.location.search);
      const shareId = urlParams.get('share');
      
      if (shareId) {
        showDownloadSection(shareId);
      }
    }

    function showDownloadSection(shareId) {
      const allShares = JSON.parse(localStorage.getItem('philipbox_shares') || '{}');
      const shareData = allShares[shareId];
      
      if (!shareData) {
        document.getElementById('downloadSection').style.display = 'block';
        document.getElementById('downloadContent').innerHTML = `
          <p style="color: #dc3545;">âŒ ê³µìœ  íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
          <p>ê³µìœ  ID: ${shareId}</p>
        `;
        return;
      }

      // ì ‘ê·¼ íšŸìˆ˜ ì¦ê°€
      shareData.accessCount = (shareData.accessCount || 0) + 1;
      allShares[shareId] = shareData;
      localStorage.setItem('philipbox_shares', JSON.stringify(allShares));

      const downloadSection = document.getElementById('downloadSection');
      const downloadContent = document.getElementById('downloadContent');
      
      downloadSection.style.display = 'block';
      
      let html = `
        <p><strong>ğŸ“ ê³µìœ ëœ íŒŒì¼ (${shareData.files.length}ê°œ)</strong></p>
        <p><small>ğŸ“… ìƒì„±ì¼: ${new Date(shareData.createdAt).toLocaleString('ko-KR')}</small></p>
        <hr>
      `;
      
      shareData.files.forEach((file, index) => {
        html += `
          <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
            <strong>ğŸ“„ ${file.name}</strong><br>
            <small>ğŸ“Š í¬ê¸°: ${formatFileSize(file.size)}</small><br>
            <small>ğŸ·ï¸ íƒ€ì…: ${file.type}</small><br>
            <button onclick="downloadFile('${shareId}', ${index})" style="background: #28a745; margin-top: 5px;">
              â¬‡ï¸ ë‹¤ìš´ë¡œë“œ
            </button>
          </div>
        `;
      });
      
      html += `
        <hr>
        <button onclick="downloadAllFiles('${shareId}')" style="background: #007bff; font-size: 16px;">
          ğŸ“¦ ëª¨ë“  íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        </button>
      `;
      
      downloadContent.innerHTML = html;
    }

    function downloadFile(shareId, fileIndex) {
      const allShares = JSON.parse(localStorage.getItem('philipbox_shares') || '{}');
      const shareData = allShares[shareId];
      
      if (!shareData || !shareData.files[fileIndex]) {
        alert('âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const file = shareData.files[fileIndex];
      
      // Data URLì„ Blobìœ¼ë¡œ ë³€í™˜
      const dataURL = file.data;
      const byteCharacters = atob(dataURL.split(',')[1]);
      const byteNumbers = new Array(byteCharacters.length);
      
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray], { type: file.type });
      
      // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = file.name;
      a.style.display = 'none';
      
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      URL.revokeObjectURL(url);
      
      alert(`âœ… ${file.name} ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    function downloadAllFiles(shareId) {
      const allShares = JSON.parse(localStorage.getItem('philipbox_shares') || '{}');
      const shareData = allShares[shareId];
      
      if (!shareData || shareData.files.length === 0) {
        alert('âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      shareData.files.forEach((file, index) => {
        setTimeout(() => {
          downloadFile(shareId, index);
        }, index * 500); // 500ms ê°„ê²©ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
      });
      
      alert(`ğŸ“¦ ${shareData.files.length}ê°œ íŒŒì¼ì˜ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤.`);
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
  </script>

</body>
</html> 